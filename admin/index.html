<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¸”ë¡œê·¸ ê´€ë¦¬ì | jehongsem</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* [ìŠ¤íƒ€ì¼ ì‹œíŠ¸ - ê¸°ì¡´ ë””ìì¸ ìœ ì§€ ë° ìµœì í™”] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background: #f5f7fa; color: #333; }
        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-box { background: white; padding: 48px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); width: 100%; max-width: 420px; }
        .login-box h1 { font-size: 24px; margin-bottom: 8px; text-align: center; }
        .login-box p { color: #666; margin-bottom: 32px; font-size: 14px; text-align: center; line-height: 1.6; }
        .login-box input { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 16px; }
        .login-box button { width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .app { display: none; min-height: 100vh; }
        .app.active { display: flex; }
        .sidebar { width: 260px; background: #1a1f36; color: white; padding: 24px 0; position: fixed; height: 100vh; }
        .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 24px; }
        .nav-section { padding: 0 16px; margin-bottom: 24px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; opacity: 0.7; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); opacity: 1; }
        .nav-item.active { background: #667eea; }
        .main-content { flex: 1; margin-left: 260px; padding: 32px; }
        .posts-table { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; width: 100%; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-size: 13px; color: #666; }
        .category { display: inline-block; padding: 4px 12px; background: #e8f4fd; color: #1976d2; border-radius: 20px; font-size: 12px; }
        .editor-container { display: none; background: white; border-radius: 12px; padding: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .editor-container.active { display: block; }
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; }
        .btn-save { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .toast { position: fixed; bottom: 32px; right: 32px; padding: 16px 24px; border-radius: 8px; color: white; display: none; z-index: 1000; }
        .loading { padding: 40px; text-align: center; color: #666; }
        @media (max-width: 768px) { .sidebar { width: 100%; position: relative; height: auto; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>ğŸ” ë¸”ë¡œê·¸ ê´€ë¦¬ì</h1>
            <p>GitHub Personal Access Tokenì„ ì…ë ¥í•˜ì—¬<br><b>jehongsem/personal_blog</b> ê´€ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</p>
            <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx">
            <button onclick="login()">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div class="app" id="app">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ“ My Blog Admin</h1>
                <p>jehongsem/personal_blog</p>
            </div>
            <div class="nav-section">
                <div class="nav-item active" onclick="showPage('posts')">ğŸ“„ í¬ìŠ¤íŠ¸ ê´€ë¦¬</div>
                <div class="nav-item" onclick="showPage('main-page')">ğŸ  ë©”ì¸ í˜ì´ì§€</div>
                <div class="nav-item" onclick="showPage('images')">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì•ˆë‚´</div>
            </div>
            <div style="padding: 24px;"><button onclick="logout()" style="width:100%; padding:8px; background:rgba(255,255,255,0.1); color:white; border:none; border-radius:4px; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button></div>
        </aside>

        <main class="main-content">
            <div id="page-posts">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <h2>í¬ìŠ¤íŠ¸ ëª©ë¡</h2>
                    <button class="btn-save" onclick="newPost()">+ ìƒˆ í¬ìŠ¤íŠ¸</button>
                </div>
                <div class="posts-table">
                    <table>
                        <thead>
                            <tr><th>ì œëª©</th><th>ì¹´í…Œê³ ë¦¬</th><th>ë‚ ì§œ</th><th>ì‘ì—…</th></tr>
                        </thead>
                        <tbody id="postsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-editor" class="editor-container">
                <h2 id="editorTitle" style="margin-bottom:24px;">ìƒˆ í¬ìŠ¤íŠ¸</h2>
                <form id="postForm">
                    <input type="hidden" id="originalFilename">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div class="form-group">
                            <label>íŒŒì¼ ID (ì˜ë¬¸/ìˆ«ì/í•˜ì´í”ˆ)</label>
                            <input type="text" id="fileId" placeholder="example-post" required>
                        </div>
                        <div class="form-group">
                            <label>ì¹´í…Œê³ ë¦¬</label>
                            <select id="postCategory">
                                <option value="notice">ê³µì§€ì‚¬í•­</option>
                                <option value="tech">ê¸°ìˆ /ê°œë°œ</option>
                                <option value="daily">ì¼ìƒ</option>
                                <option value="project">í”„ë¡œì íŠ¸</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì œëª©</label>
                        <input type="text" id="postTitle" required>
                    </div>
                    <div class="form-group">
                        <label>ë³¸ë¬¸ (HTML ì§€ì›)</label>
                        <textarea id="postContent" rows="15"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ëŒ€í‘œ ì´ë¯¸ì§€ URL</label>
                        <input type="text" id="postImage" placeholder="images/sample.jpg">
                    </div>
                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="postDate">
                    </div>
                    <div style="display:flex; gap:12px;">
                        <button type="submit" class="btn-save">ì €ì¥í•˜ê¸°</button>
                        <button type="button" onclick="cancelEdit()" style="padding:12px 24px; border:none; border-radius:8px; cursor:pointer;">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>

            <div id="page-main-page" style="display:none;">
                <h2>ë©”ì¸ í˜ì´ì§€ ì„¤ì •</h2>
                <div class="editor-container active" style="margin-top:24px;">
                    <form id="mainPageForm">
                        <div class="form-group"><label>íˆì–´ë¡œ ì œëª©</label><input type="text" id="heroTitle"></div>
                        <div class="form-group"><label>íˆì–´ë¡œ ë¶€ì œëª©</label><input type="text" id="heroSubtitle"></div>
                        <button type="submit" class="btn-save">ì„¤ì • ì €ì¥</button>
                    </form>
                </div>
            </div>

            <div id="page-images" style="display:none;">
                <h2>ì´ë¯¸ì§€ ê´€ë¦¬</h2>
                <div class="editor-container active" style="margin-top:24px;">
                    <p>ì´ë¯¸ì§€ëŠ” GitHub ì €ì¥ì†Œì˜ <b>images/</b> í´ë”ì— ì§ì ‘ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</p>
                    <p style="margin-top:10px;">ì‚¬ìš©ë²•: <code>images/íŒŒì¼ëª….jpg</code></p>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // [ì„¤ì •]
        const REPO = 'jehongsem/personal_blog';
        const BRANCH = 'main';
        
        let token = '';
        let posts = [];
        let indexData = [];

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('github_token');
            if (savedToken) {
                token = savedToken;
                showApp();
            }
            document.getElementById('postForm').addEventListener('submit', savePost);
            document.getElementById('mainPageForm').addEventListener('submit', saveMainPage);
        });

        async function login() {
            const inputToken = document.getElementById('tokenInput').value.trim();
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO}`, {
                    headers: { 'Authorization': `token ${inputToken}` }
                });
                if (res.ok) {
                    token = inputToken;
                    localStorage.setItem('github_token', token);
                    showApp();
                } else { alert('í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì €ì¥ì†Œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); }
            } catch (e) { alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'); }
        }

        function logout() {
            localStorage.removeItem('github_token');
            location.reload();
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').classList.add('active');
            loadPosts();
        }

        function showPage(page) {
            ['page-posts', 'page-editor', 'page-main-page', 'page-images'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.display = 'none';
                if(el) el.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            if (page === 'posts') {
                document.getElementById('page-posts').style.display = 'block';
                loadPosts();
            } else {
                const target = document.getElementById(`page-${page}`);
                target.style.display = 'block';
                target.classList.add('active');
                if (page === 'main-page') loadMainPage();
            }
        }

        async function githubAPI(endpoint, options = {}) {
            return fetch(`https://api.github.com/repos/${REPO}${endpoint}`, {
                ...options,
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', ...options.headers }
            });
        }

        async function getFile(path) {
            const res = await githubAPI(`/contents/${path}?ref=${BRANCH}`);
            if (res.ok) {
                const data = await res.json();
                return { content: JSON.parse(decodeURIComponent(escape(atob(data.content)))), sha: data.sha };
            }
            return null;
        }

        async function saveFile(path, content, sha = null, message = 'Update via Admin') {
            const body = { message, content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))), branch: BRANCH };
            if (sha) body.sha = sha;
            const res = await githubAPI(`/contents/${path}`, { method: 'PUT', body: JSON.stringify(body) });
            return res.ok;
        }

        async function loadPosts() {
            const tbody = document.getElementById('postsTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>';
            try {
                const indexFile = await getFile('posts/index.json');
                indexData = indexFile ? indexFile.content : [];
                
                const res = await githubAPI(`/contents/posts?ref=${BRANCH}`);
                const files = await res.json();
                
                posts = [];
                for (const file of files) {
                    if (file.name.endsWith('.json') && file.name !== 'index.json') {
                        const postContent = await getFile(`posts/${file.name}`);
                        if (postContent) posts.push({ filename: file.name, sha: postContent.sha, ...postContent.content });
                    }
                }
                posts.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderPosts();
            } catch (e) { tbody.innerHTML = '<tr><td colspan="4" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>'; }
        }

        function renderPosts() {
            const tbody = document.getElementById('postsTableBody');
            if (posts.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;">í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
            tbody.innerHTML = posts.map(post => `
                <tr>
                    <td><b>${post.title}</b></td>
                    <td><span class="category">${post.category}</span></td>
                    <td>${post.date}</td>
                    <td>
                        <button onclick="editPost('${post.filename}')" style="margin-right:8px; cursor:pointer;">í¸ì§‘</button>
                        <button onclick="deletePost('${post.filename}', '${post.sha}')" style="color:red; cursor:pointer;">ì‚­ì œ</button>
                    </td>
                </tr>
            `).join('');
        }

        function newPost() {
            showPage('editor');
            document.getElementById('editorTitle').textContent = 'ìƒˆ í¬ìŠ¤íŠ¸ ì‘ì„±';
            document.getElementById('postForm').reset();
            document.getElementById('originalFilename').value = '';
            document.getElementById('postDate').valueAsDate = new Date();
        }

        function editPost(filename) {
            const post = posts.find(p => p.filename === filename);
            if (!post) return;
            showPage('editor');
            document.getElementById('editorTitle').textContent = 'í¬ìŠ¤íŠ¸ í¸ì§‘';
            document.getElementById('originalFilename').value = filename;
            document.getElementById('fileId').value = post.id || filename.replace('.json', '');
            document.getElementById('postTitle').value = post.title;
            document.getElementById('postContent').value = post.content;
            document.getElementById('postCategory').value = post.category;
            document.getElementById('postDate').value = post.date;
            document.getElementById('postImage').value = post.image || '';
        }

        async function savePost(e) {
            e.preventDefault();
            const fileId = document.getElementById('fileId').value.trim();
            const filename = `${fileId}.json`;
            const originalFilename = document.getElementById('originalFilename').value;
            
            const postData = {
                id: fileId,
                title: document.getElementById('postTitle').value,
                content: document.getElementById('postContent').value,
                category: document.getElementById('postCategory').value,
                date: document.getElementById('postDate').value,
                image: document.getElementById('postImage').value
            };

            try {
                let sha = null;
                if (originalFilename) {
                    const existing = posts.find(p => p.filename === originalFilename);
                    sha = existing ? existing.sha : null;
                    if (originalFilename !== filename) {
                        await githubAPI(`/contents/posts/${originalFilename}`, {
                            method: 'DELETE',
                            body: JSON.stringify({ message: `Rename ${originalFilename} to ${filename}`, sha, branch: BRANCH })
                        });
                        sha = null;
                    }
                }

                const success = await saveFile(`posts/${filename}`, postData, sha);
                if (success) {
                    indexData = indexData.filter(f => f !== originalFilename);
                    if (!indexData.includes(filename)) indexData.push(filename);
                    const idxFile = await getFile('posts/index.json');
                    await saveFile('posts/index.json', indexData, idxFile ? idxFile.sha : null);
                    
                    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    showPage('posts');
                }
            } catch (e) { alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'); }
        }

        async function deletePost(filename, sha) {
            if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                const res = await githubAPI(`/contents/posts/${filename}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ message: 'Delete post', sha, branch: BRANCH })
                });
                if (res.ok) {
                    indexData = indexData.filter(f => f !== filename);
                    const idxFile = await getFile('posts/index.json');
                    await saveFile('posts/index.json', indexData, idxFile ? idxFile.sha : null);
                    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadPosts();
                }
            } catch (e) { alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'); }
        }

        function cancelEdit() { showPage('posts'); }

        async function loadMainPage() {
            const data = await getFile('content.json');
            if (data) {
                document.getElementById('heroTitle').value = data.content.hero?.title || '';
                document.getElementById('heroSubtitle').value = data.content.hero?.subtitle || '';
                document.getElementById('mainPageForm').dataset.sha = data.sha;
            }
        }

        async function saveMainPage(e) {
            e.preventDefault();
            const sha = e.target.dataset.sha;
            const newData = {
                hero: {
                    title: document.getElementById('heroTitle').value,
                    subtitle: document.getElementById('heroSubtitle').value
                }
            };
            const success = await saveFile('content.json', newData, sha);
            if (success) showToast('ë©”ì¸ í˜ì´ì§€ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            t.style.background = '#333';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html>
